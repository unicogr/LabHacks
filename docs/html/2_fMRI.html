
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>2. Cortical surface reconstruction of fMRI data &#8212; researchLog  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. References" href="References.html" />
    <link rel="prev" title="1. Documenting research with Sphinxl" href="1_Sphinx.html" />
    <link href="_static/style.css" rel="stylesheet" type="text/css">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/nico-logo.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Research Log</p>






<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1_Sphinx.html">1. <span style="color:black">Documenting research with <em>Sphinx</em>l</span></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. <span style="color:black"> Cortical surface reconstruction of fMRI data </span></a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-pipeline-prf-maping-using-7t-fmri-data">2.1. Example pipeline: pRF maping using 7T-fMRI data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#discussion">2.2. <span style="color:lightblue">Discussionüìú</span></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="References.html">3. <span style="color:black">References</span></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Codebook:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">myCodeIsYourCode</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="1_Sphinx.html" title="previous chapter"><span class="section-number">1. </span><span style="color:black">Documenting research with <em>Sphinx</em>l</span></a></li>
      <li>Next: <a href="References.html" title="next chapter"><span class="section-number">3. </span><span style="color:black">References</span></a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="1_Sphinx.html" title="Previous document"><span class="section-number">1. </span><span style="color:black">Documenting research with <em>Sphinx</em>l</span></a>
        </li>
        <li>
          <a href="References.html" title="Next document"><span class="section-number">3. </span><span style="color:black">References</span></a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="cortical-surface-reconstruction-of-fmri-data">
<h1><span class="section-number">2. </span><span style="color:black"> Cortical surface reconstruction of fMRI data </span><a class="headerlink" href="#cortical-surface-reconstruction-of-fmri-data" title="Permalink to this heading">¬∂</a></h1>
<p>An important step in using functional MRI is the design of stimuli to target specific cortical regions and functions. Computational neuroimaging of the human visual cortex often relies on standard retinotopic paradigms that reflect the structure of the visual cortex (<em>e.g.</em>, rotating wedges, expanding rings, drifting bars) <span id="id1"><sup><a class="reference internal" href="References.html#id8" title="Wandel BA. Dumoulin SO. Brewer AA. Visual field maps in human cortex. Neuron, 56(6):366-368, 2007. doi:10.1016/j.neuron.2007.10.012.">1</a>,<a class="reference internal" href="References.html#id5" title="Mark M. Schira, Christopher W. Tyler, Branka Spehar, and Michael Breakspear. Modeling magnification and anisotropy in the primate foveal confluence. PLoS Computational Biology, 6(1):e1000651, 2010. doi:10.1371/journal.pcbi.1000651.">2</a></sup></span>. These types of stimuli enable the mapping of retinotopic cortical areas using methods such as population receptive field (pRF) modeling. In this tutorial, we will learn how to process fMRI and anatomical MRI data to project the BOLD time series to a cortical surface reconstruction. Additionally, we will learn some basic shell script commands and python.</p>
<p>The requirements for Friday‚Äôs tutorial are:</p>
<ul class="simple">
<li><p>Linux. Here I use Ubuntu 22.</p></li>
<li><p>For the shell-script based part: <code class="docutils literal notranslate"><span class="pre">AFNI</span></code>, <code class="docutils literal notranslate"><span class="pre">Freesurfer</span></code>, <code class="docutils literal notranslate"><span class="pre">FSL</span></code> and <code class="docutils literal notranslate"><span class="pre">ANTS</span></code> (optional for now).</p></li>
<li><p>For the python based part: scipy, numpy, ipyvolume, and -crucially, neuropythy.</p></li>
</ul>
<section id="example-pipeline-prf-maping-using-7t-fmri-data">
<h2><span class="section-number">2.1. </span>Example pipeline: pRF maping using 7T-fMRI data<a class="headerlink" href="#example-pipeline-prf-maping-using-7t-fmri-data" title="Permalink to this heading">¬∂</a></h2>
<blockquote>
<div><p>This is a work in progress!</p>
</div></blockquote>
<p>Here the preprocessing for the functional retinotopy data. First we create an environment with unset variables (so when we run it again things do no get scrambled). Here we ‚Äúsummon‚Äù our favorite neuroimaging software packages and define paths:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">FSLDIR</span><span class="o">=</span>/home/nicolas/Programas/fsl<span class="w"> </span>
.<span class="w"> </span><span class="si">${</span><span class="nv">FSLDIR</span><span class="si">}</span>/etc/fslconf/fsl.sh
<span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">FSLDIR</span><span class="si">}</span>/bin:<span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>
<span class="nb">export</span><span class="w"> </span>FSLDIR<span class="w"> </span>PATH


<span class="c1"># Data folders</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FREESURFER_HOME</span><span class="o">=</span>/home/nicolas/Programas/freesurfer-linux-ubuntu22_amd64-7.4.0/freesurfer
<span class="nb">source</span><span class="w"> </span><span class="nv">$FREESURFER_HOME</span>/SetUpFreeSurfer.sh
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/home/nicolas/Programas/ants-2.5.4/bin:<span class="nv">$PATH</span>


<span class="c1"># Clear all variables </span>
<span class="nb">unset</span><span class="w"> </span>current_dir
<span class="nb">unset</span><span class="w"> </span>data_folder
<span class="nb">unset</span><span class="w"> </span>pth
<span class="nb">unset</span><span class="w"> </span>subj_id
<span class="nb">unset</span><span class="w"> </span>subj
<span class="nb">unset</span><span class="w"> </span>ret_folders
<span class="nb">unset</span><span class="w"> </span>moving_images
<span class="nb">unset</span><span class="w"> </span>static_images
<span class="nb">unset</span><span class="w"> </span>sorted_folders


<span class="c1"># Define the current working directory</span>
<span class="nv">current_dir</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>

<span class="c1"># Define the paths based on the current working directory</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">data_folder</span><span class="o">=</span>/home/nicolas/Documents/Paris/UNICOG/Analyses/fMRIdata/iCORTEX
<span class="nb">export</span><span class="w"> </span><span class="nv">pth</span><span class="o">=</span><span class="si">${</span><span class="nv">data_folder</span><span class="si">}</span>/sub-00/func

<span class="c1"># Define the subject ID and subject folder</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">subj_id</span><span class="o">=</span>cg220008-2898_001
<span class="nb">export</span><span class="w"> </span><span class="nv">subj</span><span class="o">=</span>sub-00

<span class="c1"># Change to the subject&#39;s data directory</span>
<span class="nb">cd</span><span class="w"> </span><span class="si">${</span><span class="nv">data_folder</span><span class="si">}</span>/<span class="si">${</span><span class="nv">subj_id</span><span class="si">}</span>
</pre></div>
</div>
<p>Next, we find the files with RET1, RET2, RET* in their name, excluding those with SBRef:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find all folders with the string RET1, RET2, RET* in their name, excluding those with SBRef</span>
<span class="nv">ret_folders</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*AP-RET*&quot;</span><span class="w"> </span>!<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*SBRef*&quot;</span><span class="k">)</span>

<span class="c1"># Declare variable for moving_images and static_images</span>
<span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span>moving_images
<span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span>static_images

<span class="c1"># Populate the variable and indices using IFS (Internal Field Separator)</span>
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span><span class="w"> </span><span class="nv">sorted_folders</span><span class="o">=(</span><span class="k">$(</span>sort<span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">ret_folders</span><span class="p">[*]</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span><span class="o">)</span>
<span class="nb">unset</span><span class="w"> </span>IFS

<span class="c1"># Initialize the counter</span>
<span class="nv">counter</span><span class="o">=</span><span class="m">1</span>

<span class="k">for</span><span class="w"> </span>folder<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">sorted_folders</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>moving_images<span class="o">[</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">folder</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="c1"># Extract the first six digits from the folder name</span>
<span class="w">    </span><span class="nv">folder_name</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="nv">folder_index</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">folder_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;_&#39;</span><span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Subtract 2 from the first six digits to get the static index</span>
<span class="w">    </span><span class="nv">static_index</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;%06d&quot;</span><span class="w"> </span><span class="k">$((</span><span class="m">10#</span><span class="si">${</span><span class="nv">folder_index</span><span class="si">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="k">)))</span>

<span class="w">    </span><span class="c1"># Find the corresponding folder with the static_index</span>
<span class="w">    </span><span class="nv">static_folder</span><span class="o">=</span><span class="k">$(</span>find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>d<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">static_index</span><span class="si">}</span><span class="s2">*&quot;</span><span class="k">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># Save the names of the folders in the variable</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">static_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>static_images<span class="o">[</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">counter</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">static_folder</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Index for static image: </span><span class="si">${</span><span class="nv">static_index</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Index for moving image: </span><span class="si">${</span><span class="nv">folder_index</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="w">    </span><span class="nv">counter</span><span class="o">=</span><span class="k">$((</span><span class="nv">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="k">))</span>
<span class="k">done</span>

<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">moving_image</span><span class="o">=</span><span class="si">${</span><span class="nv">moving_images</span><span class="p">[</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
<span class="w">    </span><span class="nv">static_image</span><span class="o">=</span><span class="si">${</span><span class="nv">static_images</span><span class="p">[</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Name for moving image: </span><span class="si">${</span><span class="nv">moving_image</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Name for static image: </span><span class="si">${</span><span class="nv">static_image</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>And convert the <code class="docutils literal notranslate"><span class="pre">dicom</span></code> files within these folders to <code class="docutils literal notranslate"><span class="pre">nifti</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run dcm2niix_afni for moving_images and static_images in ascending order</span>
<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">moving_image</span><span class="o">=</span><span class="si">${</span><span class="nv">moving_images</span><span class="p">[</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>
<span class="w">    </span><span class="nv">static_image</span><span class="o">=</span><span class="si">${</span><span class="nv">static_images</span><span class="p">[</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="p">]</span><span class="si">}</span>

<span class="w">    </span><span class="c1"># Run dcm2niix_afni for moving_image</span>
<span class="w">    </span>dcm2niix_afni<span class="w"> </span>-o<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="w"> </span>-z<span class="w"> </span>y<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">data_folder</span><span class="si">}</span>/<span class="si">${</span><span class="nv">subj_id</span><span class="si">}</span>/<span class="si">${</span><span class="nv">moving_image</span><span class="si">}</span>

<span class="w">    </span><span class="c1"># Run dcm2niix_afni for static_image</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">static_image</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>dcm2niix_afni<span class="w"> </span>-o<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="w"> </span>-z<span class="w"> </span>y<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;static_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="si">${</span><span class="nv">data_folder</span><span class="si">}</span>/<span class="si">${</span><span class="nv">subj_id</span><span class="si">}</span>/<span class="si">${</span><span class="nv">static_image</span><span class="si">}</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># Print completion message</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;dcm2niix_afni processing and renaming completed for all images.&quot;</span>
</pre></div>
</div>
<p>Apply slice timing correction:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Slice time correct the NIfTI files using 3dTshift</span>
<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">moving_nifti</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
<span class="w">    </span><span class="nv">static_nifti</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/static_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">moving_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>3dTshift<span class="w"> </span>-verbose<span class="w"> </span>-TR<span class="w"> </span><span class="m">2</span><span class="w"> </span>-tpattern<span class="w"> </span>altplus<span class="w"> </span>-ignore<span class="w"> </span><span class="m">0</span><span class="w"> </span>-tzero<span class="w"> </span><span class="m">0</span><span class="w"> </span>-Fourier<span class="w"> </span>-prefix<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/tshift_moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">moving_nifti</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">static_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>3dTshift<span class="w"> </span>-verbose<span class="w"> </span>-TR<span class="w"> </span><span class="m">2</span><span class="w"> </span>-tpattern<span class="w"> </span>altplus<span class="w"> </span>-ignore<span class="w"> </span><span class="m">0</span><span class="w"> </span>-tzero<span class="w"> </span><span class="m">0</span><span class="w"> </span>-Fourier<span class="w"> </span>-prefix<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/tshift_static_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">static_nifti</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># Print completion message</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Slice time correction completed for all images.&quot;</span>
</pre></div>
</div>
<p>Then motion correction:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Motion correct the output of moving_images using 3dvolreg</span>
<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">tshift_moving_nifti</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/tshift_moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">tshift_moving_nifti</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>3dvolreg<span class="w"> </span>-verbose<span class="w"> </span>-prefix<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/volreg_moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">tshift_moving_nifti</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># Print completion message</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Motion correction completed for moving images.&quot;</span>
</pre></div>
</div>
<p>Now is time for distortion correction. Note that the fieldmap is computed using the original data, and the results applied to the slice-timing and motion corrected data. For illustration purposes, here we use <code class="docutils literal notranslate"><span class="pre">fsl</span></code> here but <code class="docutils literal notranslate"><span class="pre">AFNI</span></code> or <code class="docutils literal notranslate"><span class="pre">ANTS</span></code> may in some cases be preferable.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">## Compute warps and apply distortion correction for each run</span>
<span class="c1"># Create the acquisition parameters file</span>
cat<span class="w"> </span><span class="s">&lt;&lt;EOT &gt; ${pth}/acqparams.txt</span>
<span class="s">0 -1 0 0.05</span>
<span class="s">0 1 0 0.05</span>
<span class="s">EOT</span>

<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w">   </span>
<span class="w"> </span>
<span class="w">    </span><span class="c1"># Combine AP and PA images into a single 4D file</span>
<span class="w">    </span>fslroi<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/moving_images_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>.nii.gz<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/AP_image.nii.gz<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span>fslroi<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/static_images_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>.nii.gz<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/PA_image.nii.gz<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span>fslmerge<span class="w"> </span>-t<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/combined_AP_PA.nii.gz<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/AP_image.nii.gz<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/PA_image.nii.gz

<span class="w">    </span><span class="c1"># Run topup</span>
<span class="w">    </span>topup<span class="w"> </span>--imain<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/combined_AP_PA.nii.gz<span class="w"> </span>--datain<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/acqparams.txt<span class="w"> </span>--config<span class="o">=</span>b02b0.cnf<span class="w"> </span>--out<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/topup_results<span class="w"> </span>--iout<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/hifi_b0.nii.gz<span class="w"> </span>--fout<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/fieldmap.nii.gz

<span class="w">    </span><span class="c1"># Apply the distortion correction to the volreg moving images</span>
<span class="w">    </span><span class="nv">moving_image</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/volreg_moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
<span class="w">    </span><span class="nv">corrected_moving_image</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span><span class="s2">/corrected_moving_images_</span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span>
<span class="w">    </span>applytopup<span class="w"> </span>--imain<span class="o">=</span><span class="si">${</span><span class="nv">moving_image</span><span class="si">}</span><span class="w"> </span>--datain<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/acqparams.txt<span class="w"> </span>--inindex<span class="o">=</span><span class="m">1</span><span class="w"> </span>--topup<span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/topup_results<span class="w"> </span>--out<span class="o">=</span><span class="si">${</span><span class="nv">corrected_moving_image</span><span class="si">}</span><span class="w"> </span>--method<span class="o">=</span>jac

<span class="w">    </span><span class="c1"># Clean up topup results</span>
<span class="w">    </span>rm<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/AP_image.nii.gz<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/PA_image.nii.gz<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/combined_AP_PA*
<span class="w">    </span>rm<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/hifi_b0*
<span class="w">    </span>rm<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/fieldmap.nii.gz
<span class="w">    </span>rm<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/topup_results*
<span class="w">    </span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Distortion correction completed for moving image </span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.&quot;</span>

<span class="k">done</span>

<span class="c1"># Print completion message</span>
<span class="c1">#rm ${pth}/acqparams.txt</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Distortion correction completed for all moving images.&quot;</span>
</pre></div>
</div>
<p>Now we can align corrected data to the subject‚Äôs anatomical image using ‚Äúboundary based registration‚Äù, provided we have run <code class="docutils literal notranslate"><span class="pre">freesurfer</span></code> successfully on a 1<em>mm</em> iso-volumetric resampled anatomical data of the subject:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Align corrected data to the subject&#39;s anatomical image</span>

<span class="c1"># Define the FreeSurfer subject directory</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SUBJECTS_DIR</span><span class="o">=</span><span class="nv">$FREESURFER_HOME</span>/subjects
<span class="nb">export</span><span class="w"> </span><span class="nv">subj</span><span class="o">=</span>sub-00_iso
<span class="nb">export</span><span class="w"> </span><span class="nv">pth</span><span class="o">=</span><span class="si">${</span><span class="nv">data_folder</span><span class="si">}</span>/sub-00/func

<span class="c1"># Perform affine registration using FreeSurfer&#39;s bbregister for all corrected_moving_images_*</span>
<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">corrected_moving_image</span><span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/corrected_moving_images_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>.nii.gz
<span class="w">    </span><span class="nv">registered_image</span><span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/registered_moving_images_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>_iso.nii.gz
<span class="w">    </span><span class="nv">registration_matrix</span><span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/registration_matrix_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>.dat

<span class="w">    </span><span class="c1"># Find the brain.mgz file for the current subject</span>
<span class="w">    </span><span class="nv">brain_mgz</span><span class="o">=</span><span class="si">${</span><span class="nv">SUBJECTS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">subj</span><span class="si">}</span>/mri/brain.mgz

<span class="w">    </span><span class="c1"># Run bbregister for affine registration</span>
<span class="w">    </span>bbregister<span class="w"> </span>--s<span class="w"> </span><span class="si">${</span><span class="nv">subj</span><span class="si">}</span><span class="w"> </span>--mov<span class="w"> </span><span class="si">${</span><span class="nv">corrected_moving_image</span><span class="si">}</span><span class="w"> </span>--reg<span class="w"> </span><span class="si">${</span><span class="nv">registration_matrix</span><span class="si">}</span><span class="w"> </span>--init-header<span class="w"> </span>--init-fsl<span class="w"> </span>--t2<span class="w"> </span>--bold

<span class="w">    </span><span class="c1"># Apply the registration to the functional image</span>
<span class="w">    </span>mri_vol2vol<span class="w"> </span>--mov<span class="w"> </span><span class="si">${</span><span class="nv">corrected_moving_image</span><span class="si">}</span><span class="w"> </span>--targ<span class="w"> </span><span class="si">${</span><span class="nv">brain_mgz</span><span class="si">}</span><span class="w"> </span>--reg<span class="w"> </span><span class="si">${</span><span class="nv">registration_matrix</span><span class="si">}</span><span class="w"> </span>--o<span class="w"> </span><span class="si">${</span><span class="nv">registered_image</span><span class="si">}</span><span class="w"> </span>--no-resample

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Affine registration completed for corrected moving image </span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="k">done</span>

<span class="c1"># Print completion message</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Affine registration completed for all corrected moving images.&quot;</span>
</pre></div>
</div>
<p>Finally, for now, we check the results visually and apply manual corrections if needed:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use tkregister2 to verify the registration</span>
<span class="k">for</span><span class="w"> </span>index<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="si">${#</span><span class="nv">moving_images</span><span class="p">[@]</span><span class="si">}</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">corrected_moving_image</span><span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/corrected_moving_images_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>.nii.gz
<span class="w">    </span><span class="nv">registration_matrix</span><span class="o">=</span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/registration_matrix_<span class="si">${</span><span class="nv">index</span><span class="si">}</span>.dat
<span class="w">    </span><span class="nv">brain_mgz</span><span class="o">=</span><span class="si">${</span><span class="nv">SUBJECTS_DIR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">subj</span><span class="si">}</span>/mri/brain.mgz

<span class="w">    </span>tkregister2<span class="w"> </span>--mov<span class="w"> </span><span class="si">${</span><span class="nv">corrected_moving_image</span><span class="si">}</span><span class="w"> </span>--targ<span class="w"> </span><span class="si">${</span><span class="nv">brain_mgz</span><span class="si">}</span><span class="w"> </span>--reg<span class="w"> </span><span class="si">${</span><span class="nv">registration_matrix</span><span class="si">}</span><span class="w"> </span>--surf

<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Verification with tkregister2 completed for corrected moving image </span><span class="si">${</span><span class="nv">index</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="k">done</span>

<span class="c1"># Print completion message</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Verification with tkregister2 completed for all corrected moving images.&quot;</span><span class="w"> </span>
</pre></div>
</div>
<p>Let us have a look at the registered data for a single run using <code class="docutils literal notranslate"><span class="pre">freeview</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>


<span class="c1"># Data folders</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FREESURFER_HOME</span><span class="o">=</span>/home/nicolas/Programas/freesurfer-linux-ubuntu22_amd64-7.4.0/freesurfer
<span class="nb">source</span><span class="w"> </span><span class="nv">$FREESURFER_HOME</span>/SetUpFreeSurfer.sh
<span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/home/nicolas/Programas/ants-2.5.4/bin:<span class="nv">$PATH</span>

<span class="nb">export</span><span class="w"> </span><span class="nv">subj</span><span class="o">=</span>sub-00_iso
<span class="nb">export</span><span class="w"> </span><span class="nv">data_folder</span><span class="o">=</span>/home/nicolas/Documents/Paris/UNICOG/Analyses/fMRIdata/iCORTEX
<span class="nb">export</span><span class="w"> </span><span class="nv">pth</span><span class="o">=</span><span class="si">${</span><span class="nv">data_folder</span><span class="si">}</span>/sub-00/func
<span class="nb">export</span><span class="w"> </span><span class="nv">nifti</span><span class="o">=</span>lh.corrected_moving_images_1_iso.mgh

<span class="nb">export</span><span class="w"> </span><span class="nv">nifti</span><span class="o">=</span>registered_moving_images_1_iso.nii.gz
freeview<span class="w"> </span>-f<span class="w"> </span><span class="nv">$SUBJECTS_DIR</span>/<span class="si">${</span><span class="nv">subj</span><span class="si">}</span>/surf/lh.white<span class="w"> </span>-viewport<span class="w"> </span>3d<span class="w"> </span><span class="se">\</span>
<span class="w">         </span>-v<span class="w"> </span><span class="si">${</span><span class="nv">pth</span><span class="si">}</span>/<span class="si">${</span><span class="nv">nifti</span><span class="si">}</span><span class="w">  </span>-viewport<span class="w"> </span>3d
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p><a class="reference internal" href="_images/Freeview.png"><img alt="" class="align-center" src="_images/Freeview.png" style="height: 600px;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p><strong>Freeview</strong>. We can clearly see the modulation of the signal by the drifting bar used in the visual field mapping stimuli. We are going to use this later in order to compute pRF maps.</p></td>
</tr>
</tbody>
</table>
<p>So far all semi-automatic! Next steps:</p>
<ul class="simple">
<li><p>Fine tunning of the functional-to-anaotmical volume coregsitration (<em>e.g.</em> using <code class="docutils literal notranslate"><span class="pre">antsRegistration</span></code>).</p></li>
<li><p>Compute pRFs using an occipital mask.</p></li>
<li><p>Refactoring this to preprocess more subjects and organize the inputs and outputs results in <strong>BIDS</strong> format.</p></li>
</ul>
<p>Now we switch to python. The following has been adapted from excellent Noah Benson‚Äôs <a class="reference external" href="https://github.com/noahbenson/neuropythy-tutorials/blob/master/tutorials/plotting-2D.ipynb">tutorial</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span><span class="o">,</span><span class="w"> </span><span class="nn">six</span> <span class="c1"># six provides python 2/3 compatibility</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="c1"># The neuropythy library is a swiss-army-knife for handling MRI data, especially</span>
<span class="c1"># anatomical/structural data such as that produced by FreeSurfer or the HCP.</span>
<span class="c1"># https://github.com/noahbenson/neuropythy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">neuropythy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ny</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipyvolume</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ipv</span>


<span class="n">fs_pth</span> <span class="o">=</span> <span class="s1">&#39;/home/nicolas/Programas/freesurfer-linux-ubuntu22_amd64-7.4.0/freesurfer/subjects/&#39;</span>
<span class="n">subject_id</span> <span class="o">=</span> <span class="s1">&#39;sub-00_iso&#39;</span>
<span class="n">sub</span> <span class="o">=</span> <span class="n">ny</span><span class="o">.</span><span class="n">freesurfer_subject</span><span class="p">([</span><span class="n">fs_pth</span> <span class="o">+</span> <span class="n">subject_id</span><span class="p">])</span>
</pre></div>
</div>
<p>Get V1 coordinats fom the fsaverage registration of the subjects</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fsaverage</span> <span class="o">=</span> <span class="n">ny</span><span class="o">.</span><span class="n">freesurfer_subject</span><span class="p">(</span><span class="s1">&#39;fsaverage&#39;</span><span class="p">)</span>

<span class="n">v1_centers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">]:</span>
    <span class="c1"># Get the Cortex object for this hemisphere.</span>
    <span class="n">cortex</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="o">.</span><span class="n">hemis</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
    <span class="c1"># We&#39;re dealing with the cortical sphere, so get that surface.</span>
    <span class="n">sphere</span> <span class="o">=</span> <span class="n">cortex</span><span class="o">.</span><span class="n">registrations</span><span class="p">[</span><span class="s1">&#39;native&#39;</span><span class="p">]</span>
    <span class="c1"># Grab the V1_weight property and the coordinates.</span>
    <span class="n">v1_weight</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;V1_weight&#39;</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">.</span><span class="n">coordinates</span>
    <span class="c1"># Now, we can take a weighted average of the coordinates in V1.</span>
    <span class="n">v1_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coords</span> <span class="o">*</span> <span class="n">v1_weight</span><span class="p">[</span><span class="kc">None</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v1_center</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1_weight</span><span class="p">)</span>
    <span class="c1"># Save this in the v1_centers dict.</span>
    <span class="n">v1_centers</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1_center</span>

<span class="c1"># See what got saved:</span>
<span class="n">v1_centers</span>

<span class="n">v1_rights</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">]:</span>
    <span class="c1"># Once again, we get the Cortex object for this hemisphere and the</span>
    <span class="c1"># spherical surface.</span>
    <span class="n">cortex</span> <span class="o">=</span> <span class="n">fsaverage</span><span class="o">.</span><span class="n">hemis</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
    <span class="n">sphere</span> <span class="o">=</span> <span class="n">cortex</span><span class="o">.</span><span class="n">registrations</span><span class="p">[</span><span class="s1">&#39;native&#39;</span><span class="p">]</span>
    <span class="c1"># Now, we want the cortex_label property, which is True for points not</span>
    <span class="c1"># on the medial wall and False for points on the medial wall.</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">sphere</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;cortex_label&#39;</span><span class="p">)</span>
    <span class="c1"># We want to find the point at the middle of the medial wall, so we</span>
    <span class="c1"># want to invert this property (True values indicate the medial wall).</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="o">~</span><span class="n">weight</span>
    <span class="c1"># Now we take the weighted average again (however, since these weight</span>
    <span class="c1"># values are all True or False (1 or 0), we can just average the</span>
    <span class="c1"># points that are included.</span>
    <span class="n">mwall_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="n">weight</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># If this is the RH, we invert this coordinate</span>
    <span class="n">v1_rights</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">mwall_center</span> <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="s1">&#39;rh&#39;</span> <span class="k">else</span> <span class="n">mwall_center</span>

<span class="c1"># See what got saved.</span>
<span class="n">v1_rights</span>


</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">neuropythy</span></code> projection method to get the flat patch indices in the original surface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;orthographic&#39;</span> <span class="c1"># or: equirectangular, sinusoidal, mercator</span>
<span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>

<span class="c1"># Now, we make the projections:</span>
<span class="n">map_projs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="s1">&#39;rh&#39;</span><span class="p">]:</span> 
    <span class="n">mp</span> <span class="o">=</span> <span class="n">ny</span><span class="o">.</span><span class="n">map_projection</span><span class="p">(</span><span class="n">chirality</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                           <span class="n">center</span><span class="o">=</span><span class="n">v1_centers</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
                           <span class="n">center_right</span><span class="o">=</span><span class="n">v1_rights</span><span class="p">[</span><span class="n">h</span><span class="p">],</span>
                           <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                           <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                           <span class="n">registration</span><span class="o">=</span><span class="s1">&#39;native&#39;</span><span class="p">)</span>
    <span class="n">map_projs</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span>

<span class="c1"># See what this created.</span>
<span class="n">map_projs</span>

<span class="n">flatmaps</span> <span class="o">=</span> <span class="p">{</span><span class="n">h</span><span class="p">:</span> <span class="n">mp</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">hemis</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">map_projs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<span class="n">flatmaps</span>

<span class="n">lh_cortex_label</span> <span class="o">=</span> <span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">rh_cortex_label</span> <span class="o">=</span> <span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">lh_cortex_label</span>
</pre></div>
</div>
<p>Plot flat patches and medial wall:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll make two axes, one for each hemisphere.</span>
<span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">left_ax</span><span class="p">,</span> <span class="n">right_ax</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">72</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># Make sure there isn&#39;t a bunch of extra space around them.</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span><span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">left_ax</span><span class="p">)</span>
<span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span><span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">right_ax</span><span class="p">)</span>

<span class="n">left_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">right_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>

<span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">left_ax</span><span class="p">,</span> <span class="n">right_ax</span><span class="p">))</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">72</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>


<span class="n">lh_cortex_label</span> <span class="o">=</span> <span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;cortex_label&#39;</span><span class="p">)</span>
<span class="n">rh_cortex_label</span> <span class="o">=</span> <span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;cortex_label&#39;</span><span class="p">)</span>


<span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span><span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">left_ax</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="n">lh_cortex_label</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>
<span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span><span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">right_ax</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="n">rh_cortex_label</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">)</span>

<span class="n">left_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">right_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>   
</pre></div>
</div>
<p>Load co-registered and surface projected time series and compute t-SNR:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">nibabel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Load the .mgh files</span>
<span class="c1"># Define the path to the functional image</span>
<span class="n">pth</span> <span class="o">=</span> <span class="s1">&#39;/home/nicolas/Documents/Paris/UNICOG/Analyses/fMRIdata/iCORTEX/sub-00/func/&#39;</span>

<span class="n">lh_surfBOLD</span> <span class="o">=</span> <span class="s1">&#39;lh.corrected_moving_images_1_iso.mgh&#39;</span>
<span class="n">rh_surfBOLD</span> <span class="o">=</span> <span class="s1">&#39;rh.corrected_moving_images_1_iso.mgh&#39;</span>

<span class="c1"># Load the projected time series</span>
<span class="n">lh_time_series_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="s1">&#39;lh.corrected_moving_images_1_iso.mgh&#39;</span><span class="p">)</span>
<span class="n">rh_time_series_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span> <span class="s1">&#39;rh.corrected_moving_images_1_iso.mgh&#39;</span><span class="p">)</span>

<span class="n">lh_time_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">lh_time_series_path</span> <span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
<span class="n">rh_time_series</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rh_time_series_path</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lh_time_series</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">flatmaps</span> <span class="o">=</span> <span class="p">{</span><span class="n">h</span><span class="p">:</span> <span class="n">mp</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">hemis</span><span class="p">[</span><span class="n">h</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span> <span class="ow">in</span> <span class="n">map_projs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">lh_cortex_index</span> <span class="o">=</span> <span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="n">rh_cortex_index</span> <span class="o">=</span> <span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prop</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>



<span class="c1"># Calculate the temporal-SNR (temporal standard deviation of the time series)</span>
<span class="n">lh_tsnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lh_time_series</span><span class="p">[</span><span class="n">lh_cortex_index</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">rh_tsnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rh_time_series</span><span class="p">[</span><span class="n">rh_cortex_index</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">lh_tsnr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span><span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;lh&#39;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">left_ax</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="n">lh_tsnr</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="s1">&#39;V1_weight&#39;</span><span class="p">)</span>


<span class="n">ny</span><span class="o">.</span><span class="n">cortex_plot</span><span class="p">(</span><span class="n">flatmaps</span><span class="p">[</span><span class="s1">&#39;rh&#39;</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">right_ax</span><span class="p">,</span>
               <span class="n">color</span><span class="o">=</span><span class="n">rh_tsnr</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="s1">&#39;V1_weight&#39;</span><span class="p">)</span>

<span class="n">left_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">right_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Some preliminary figures:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p><a class="reference internal" href="_images/tSNR_V1.png"><img alt="" class="align-center" src="_images/tSNR_V1.png" style="height: 400px;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p><strong>Temporal SNR in V1</strong>.</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p><a class="reference internal" href="_images/tSNR_outsideV1.png"><img alt="" class="align-center" src="_images/tSNR_outsideV1.png" style="height: 400px;" /></a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p><strong>Temporal SNR outside V1</strong>.</p></td>
</tr>
</tbody>
</table>
<p>Remember, this is work in progress!</p>
<p>The neuroimaging python package <strong>Neuropythy</strong> is very versatile but a little cumbersome to learn. See here for its <a class="reference external" href="https://nben.net/docs/neuropythy/html/genindex.html">documentation</a>, and <a class="reference external" href="https://nben.net/Retinotopy-Tutorial/">here</a> for a nice retinotopy tutorial, and <a class="reference external" href="https://nben.net/MRI-Geometry/">here</a> for details on MRI Data Representation and Geometry.</p>
<p><strong>Next</strong>: using <a class="reference external" href="https://github.com/VU-Cog-Sci/prfpy">prfpy</a> to compute population receptive field maps.</p>
</section>
<section id="discussion">
<h2><span class="section-number">2.2. </span><span style="color:lightblue">Discussionüìú</span><a class="headerlink" href="#discussion" title="Permalink to this heading">¬∂</a></h2>
<script src="https://giscus.app/client.js"
        data-repo="nicogravel/researchLog_template"
        data-repo-id="R_kgDON90EnA"
        data-category="Giscus!"
        data-category-id="DIC_kwDON90EnM4CnVS9"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="gruvbox"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
</section>
</section>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="1_Sphinx.html" title="Previous document"><span class="section-number">1. </span><span style="color:black">Documenting research with <em>Sphinx</em>l</span></a>
        </li>
        <li>
          <a href="References.html" title="Next document"><span class="section-number">3. </span><span style="color:black">References</span></a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;.
      
      |
      <a href="_sources/2_fMRI.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>